---
title: Descriptive poverty analysis
output: 
  html_document: 
    toc: true
    toc_float: true
    number_sections: yes
    code_folding: hide
---


```{r setup, include = F}
library(knitr)
knitr::opts_chunk$set(list(echo=TRUE,
                           eval=FALSE,
                           cache=TRUE,
                           warning=FALSE,
                           message=FALSE))
opts_chunk$set(fig.width = 10, fig.height = 6)
library(ggplot2)
library(dplyr)
options(scipen=999)

# if (!file.exists("./data/d_merge_L_class.RData")) source("./lataa_datat.R")
# load("./data/sdmr_4_english_language_versionN.RData")
# d <- d15n
d <- readRDS("./data/sdmr15.RDS")
# lets apply the new class variables
# source("./code/class_variable_2015.R")
# Lets make the label_data()-function available
source("./code/label_data.R")
```

# Cross-sectional 2015

## monthly income 

```{r incometaulukko}

d$tulot <- d$V74c1 / 10404

d %>% # data
  mutate(sex = ifelse(V112c1 == 1, "male", "female")) %>% 
  group_by(sex) %>% # ryhmittelevä muuttuja
  mutate(V74c1 = as.integer(V74c1)) %>% 
  summarise(keskiarvo_tulot = mean(V74c1, na.rm=TRUE),
            mediaani_tulot = median(V74c1, na.rm=TRUE),
            keskihajonta_tulot = sd(V74c1,na.rm = TRUE),
            
            keskiarvo_tulot1 = mean(tulot, na.rm=TRUE),
            mediaani_tulot1 = median(tulot, na.rm=TRUE),
            keskihajonta_tulot1 = sd(tulot,na.rm = TRUE)
  ) %>% kable()
```

```{r incomekuva}
dd <- d15n %>% filter(V74c1 <= 100000)

dd <- d %>% 
  mutate(sex = ifelse(V112c1 == 1, "male", "female")) %>% 
  filter(V74c1 <= 100000)

p <- ggplot(data=dd,# data 
            aes(x=as.integer(age), # x-akselin luokitteleva muuttuja
                y=as.integer(V74c1),
                color=sex)) # y-akselin jatkuva muuttuja
# p <- p + geom_jitter(alpha=.1)
p <- p + geom_point(alpha=.3)
p <- p + geom_smooth()
p <- p + labs(x="age",y="monthly income in roubles")
p
```


## Subjective poverty

```{r subj}

dd <- d %>% 
  mutate(sex = ifelse(V112c1 == 1, "male", "female")) %>% 
  filter(V74c1 <= 100000)

## --------------
dd$subpov <- label_sdmr(dd,"V81c1")

dd <- dd[!is.na(dd$subpov),]

p <- ggplot(data=dd,# data 
            aes(x=V74c1, # x-akselin luokitteleva muuttuja
                color=subpov)) # y-akselin jatkuva muuttuja
p <- p + geom_density()
p <- p + labs(title="Monthly income distribution by income group")
p
```

# Subjective poverty and ....

>Toiseksi on aika standardimuotoinen subjektiivisen köyhyyden kysymys ts. kuinka selviytyy jokapäiväisistä menoista. Tarvittaneen siis näiden kahden vertailevaa analyysia hiukan ja olisi päätettävä kuinka köyhyyttä tai rikkautta analysoidaan. Tässä kohden voinee vähän kokeillakin ja molempia voi käyttää. Joka tapauksessa voi yrittää katsoa ensin perusdemografiset taustatiedot liittyen köyhyyden eri muotoihin (ikä, sukupuoli, alue, koulutus, mitä muuta?) ja sitten tarkastella esimerkiksi a) miten köyhyys liittyy tehtyihin luokkamuuttujiin ja b) miten se liittyy esim. yleiseen luottamukseen. Venäjältä on tiedossa yhtä ja toista sympaattista köyhyystyötä, mm. pidin taannoin luennon instituutissa tästä aiheesta ja siteerailin Gorshkovin ja Tihonovan aiheesta tehtyä kirjaa. Siinä on todella paljon tietoa ja tarkastellaan mm. mielipideilmastoa eri tuloluokissa -tulokset ovat samansuuntaisia mihin surveyaineistomme viittaa ts. eroja löytyy mutta tavanomaiset stratifikaatiotekijät eivät niitä selitä - tässä olisi mielestäni merkittävä haaste pohtia, mikä sitten. Mielestäni kannattaa rakentaa jo tehdyn tutkimuksen päälle, esim. saatuja tuloksia vahvistaen ja yhdessä ihmetellen, varoen sitä että kerromme uusina asioita jotka ovat jo yleisesti tiedossa.


```{r subjpov3, results="asis"}

bg_vars <- read.table(textConnection('

name code
"Age"  age
"Sex"  V112c1
"Education" V10c1
"Type of Settlement" V1c1
"General trust" V96c1

'), stringsAsFactors=FALSE, header=TRUE)

# lets add the institutional trust
label_data <- readRDS("./data/label_data.RDS")
trust_vars <- label_data[grepl("Trust:", label_data$name),]
trust_vars <- trust_vars[!duplicated(trust_vars$code),c("name","code")]
bg_vars <- rbind(bg_vars,trust_vars)

dd$subpov <- label_sdmr(dd,"V81c1", factor=TRUE)

for (i in bg_vars$code){
  
  if (i %in% "age"){
  dd$depend[dd[[i]] < 20] <- "Below 20"
  dd$depend[dd[[i]] >= 20 & dd$age < 30] <- "20-29"
  dd$depend[dd[[i]] >= 30 & dd$age < 40] <- "30-39"
  dd$depend[dd[[i]] >= 40 & dd$age < 50] <- "40-49"
  dd$depend[dd[[i]] >= 50 & dd$age < 60] <- "50-59"
  dd$depend[dd[[i]] >= 60 & dd$age < 70] <- "60-69"
  dd$depend[dd[[i]] >= 70] <- "70 and older"
  
  dd$depend <- factor(dd$depend, 
                      levels=c(c("Below 20",
                                 "20-29",
                                 "30-39",
                                 "40-49",
                                 "50-59",
                                 "60-69",
                                 "70 and older")))
  } else dd$depend <- label_sdmr(dd,i, factor=TRUE)
  
  tbl <- as.data.frame(prop.table(table(dd$subpov,dd$depend),2)*100)
  
  levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
  levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))
  
  cat("\n\n")
  cat(paste("##",bg_vars[bg_vars$code %in% i,]$name),"-",i)
  cat("\n\n")
  
  p <- ggplot(data=tbl,# data 
              aes(x=Var2, # x-akselin luokitteleva muuttuja
                  y=Freq,
                  fill=Var1)) # y-akselin jatkuva muuttuja
  p <- p + geom_bar(stat="identity")
  p <- p + guides(fill = guide_legend(reverse=TRUE, title="Income group"))
  p <- p + labs(title=paste("Share of respondents - ", bg_vars[bg_vars$code %in% i, "name"]),
                x=bg_vars[bg_vars$code %in% i,]$name)
  p <- p + theme(axis.text.x = element_text(angle=90))
  print(p)
  
  tbl <- as.data.frame(table(dd$subpov,dd$depend))
  
  levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
  levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))
  
  tbl$Freq <- round(tbl$Freq, 1)
  
  p <- ggplot(data=tbl,# data 
              aes(x=Var1, # x-akselin luokitteleva muuttuja
                  y=Var2,
                  fill=Freq,
                  label=Freq)) # y-akselin jatkuva muuttuja
  p <- p + geom_tile()
  p <- p + geom_text()
  p <- p + labs(title=paste("Number of cases per cell - ", bg_vars[bg_vars$code %in% i, "name"]),
                x="Income group",
                y=bg_vars[bg_vars$code %in% i,]$name)
  print(p)

}


```

# Class- variables

```{r class2015}
oldvar = "V14_CODE"
oldvar2 <- "occup_groups"
d <- dd
# Creates four new variables 
## "occup_groups"
## "occup_groups_labelled"
## "autonomia"
## "autonomia_labelled"
source("./code/create_class_2015.R")

dd <- d
tbl <- as.data.frame(prop.table(table(dd$subpov,dd$occup_groups_labelled),2)*100)

levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))

cat("\n\n")
cat("## occup_groups_labelled")
cat("\n\n")

p <- ggplot(data=tbl,# data 
            aes(x=Var2, # x-akselin luokitteleva muuttuja
                y=Freq,
                fill=Var1)) # y-akselin jatkuva muuttuja
p <- p + geom_bar(stat="identity")
p <- p + guides(fill = guide_legend(reverse=TRUE, title="Income group"))
p <- p + labs(title="Share of respondents - occup_groups_labelled",
              x="occup_groups_labelled")
p <- p + theme(axis.text.x = element_text(angle=90))
print(p)

tbl <- as.data.frame(table(dd$subpov,dd$occup_groups_labelled))

levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))

tbl$Freq <- round(tbl$Freq, 1)

p <- ggplot(data=tbl,# data 
            aes(x=Var1, # x-akselin luokitteleva muuttuja
                y=Var2,
                fill=Freq,
                label=Freq)) # y-akselin jatkuva muuttuja
p <- p + geom_tile()
p <- p + geom_text()
p <- p + labs(title="Number of cases per cell - occup_groups_labelled",
              x="Income group",
              y=bg_vars[bg_vars$code %in% i,]$name)
print(p)


tbl <- as.data.frame(prop.table(table(dd$subpov,dd$autonomia_labelled),2)*100)

levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))

cat("\n\n")
cat("## autonomia_labelled")
cat("\n\n")

p <- ggplot(data=tbl,# data 
            aes(x=Var2, # x-akselin luokitteleva muuttuja
                y=Freq,
                fill=Var1)) # y-akselin jatkuva muuttuja
p <- p + geom_bar(stat="identity")
p <- p + guides(fill = guide_legend(reverse=TRUE, title="Income group"))
p <- p + labs(title="Share of respondents - autonomia_labelled",
              x="autonomia_labelled")
p <- p + theme(axis.text.x = element_text(angle=90))
print(p)

tbl <- as.data.frame(table(dd$subpov,dd$autonomia_labelled))

levels(tbl$Var1) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var1))
levels(tbl$Var2) <- gsub('(.{1,20})(\\s|$)', '\\1\n', levels(tbl$Var2))

tbl$Freq <- round(tbl$Freq, 1)

p <- ggplot(data=tbl,# data 
            aes(x=Var1, # x-akselin luokitteleva muuttuja
                y=Var2,
                fill=Freq,
                label=Freq)) # y-akselin jatkuva muuttuja
p <- p + geom_tile()
p <- p + geom_text()
p <- p + labs(title="Number of cases per cell - autonomia_labelled",
              x="Income group",
              y=bg_vars[bg_vars$code %in% i,]$name)
print(p)


```







# Merged data

```{r load_merged_data}

# load("./data/merged_4wave20151110N.RData")
# longi <- d_merge_N
# load("./data/d_merge_N_class.RData")
# longi_class <- d_merge_N_class

```


## Class variables

```{r, eval=FALSE}
l <- d_merge_N_class


l %>% # data
  # muokataan muuttujia
  mutate(income = as.integer(v74_1998_2007_2015),
         age = 2015 - v111_1991_1998_2007_2015) %>% 
  # ryhmitellään data
  group_by(occup_groups_labelled) %>% 
  # lasketaan ryhmille tunnuslukuja tuloista ja iästä
  summarise(keskiarvo_ika = mean(age, na.rm=TRUE),
            mediaani_ika = median(age, na.rm=TRUE),
            keskihajonta_ika = sd(age,na.rm = TRUE),
            # tulot,
            keskiarvo_tulot = mean(income, na.rm=TRUE),
            mediaani_tulot = median(income, na.rm=TRUE),
            keskihajonta_tulot = sd(income,na.rm = TRUE)
  ) %>% knitr::kable() #%>% View()


l %>% # data
  # muokataan muuttujia
  mutate(income = as.integer(v74_1998_2007_2015),
         age = 2015 - v111_1991_1998_2007_2015) %>% 
  # ryhmitellään data
  group_by(autonomia_labelled) %>% 
  # lasketaan ryhmille tunnuslukuja tuloista ja iästä
  summarise(keskiarvo_ika = mean(age, na.rm=TRUE),
            mediaani_ika = median(age, na.rm=TRUE),
            keskihajonta_ika = sd(age,na.rm = TRUE),
            # tulot,
            keskiarvo_tulot = mean(income, na.rm=TRUE),
            mediaani_tulot = median(income, na.rm=TRUE),
            keskihajonta_tulot = sd(income,na.rm = TRUE)
  ) %>% knitr::kable() #%>%  View()


#' # Tulot
#' 
d <- d15l
d$tulot <- as.integer(d$V74c1) / 10404

p <- ggplot(data=d,# data 
            aes(x=as.integer(V74c1), # x-akselin luokitteleva muuttuja
                color=V112c1)) # y-akselin jatkuva muuttuja
p <- p + geom_density()
p


p <- ggplot(data=d,# data 
            aes(x=as.integer(tulot), # x-akselin luokitteleva muuttuja
                color=V112c1)) # y-akselin jatkuva muuttuja
p <- p + geom_density()
p
```



